{"version":3,"file":"plugin.js","sourceRoot":"","sources":["../../src/plugin.ts"],"names":[],"mappings":"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","sourcesContent":["import * as Path from 'path';\nimport { NgcCliOptions } from '@angular/compiler-cli';\nimport { run, isCli } from './main';\nimport { WebpackWrapper } from \"./webpack-wrapper\";\n\nexport type PathTransformer = (path: string) => string;\nexport type SourceTransformer = (path: string, source: string) => string | Promise<string>;\nexport type OnCompilationSuccess = () => void;\nexport type OnCompilationError = (err: Error) => void;\n\nexport interface NgcWebpackPluginOptions {\n  /**\n   * If false the plugin is a ghost, it will not perform any action.\n   * This property can be used to trigger AOT on/off depending on your build target (prod, staging etc...)\n   *\n   * The state can not change after initializing the plugin.\n   * @default true\n   */\n  disabled?: boolean;\n\n  pathTransformer?: PathTransformer;\n  sourceTransformer?: SourceTransformer;\n  onCompilationSuccess?: OnCompilationSuccess;\n  onCompilationError?: OnCompilationError;\n\n  /**\n   * A path to a tsconfig file, if set the AOT compilation is triggered from the plugin.\n   * When setting a tsconfig you do not need to run the compiler from the command line.\n   *\n   * @default undefined\n   */\n  tsConfig?: string;\n\n  /**\n   * A path to a file (resource) that will replace all resource referenced in @Components.\n   * For each `@Component` the AOT compiler compiles it creates new representation for the templates (html, styles)\n   * of that `@Components`. It means that there is no need for the source templates, they take a lot of\n   * space and they will be replaced by the content of this resource.\n   *\n   * To leave the template as is set to a falsy value (the default).\n   *\n   * TIP: Use an empty file as an overriding resource. It is recommended to use a \".js\" file which\n   * usually has small amount of loaders hence less performance impact.\n   *\n   * > This feature is doing NormalModuleReplacementPlugin for AOT compiled resources.\n   * @default undefined\n   */\n  resourceOverride?: string;\n\n  /**\n   * Angular compiler CLI options\n   */\n  cliOptions?: any;\n}\n\nexport class NgcWebpackPlugin {\n  public compiler: any;\n  public webpackWrapper: WebpackWrapper;\n\n  private aotPass: boolean;\n  private debug = true;\n\n  constructor(public options: NgcWebpackPluginOptions = {} as any) {\n    if (!options.hasOwnProperty('disabled')) {\n      options.disabled = false;\n    }\n  }\n\n  apply(compiler: any) {\n    if (this.options.disabled === true) return;\n\n    this.compiler = compiler;\n    this.webpackWrapper = WebpackWrapper.fromCompiler(this.compiler);\n\n    // if not from cli and no config file then we never have AOT pass...\n    this.aotPass = !isCli() && !this.options.tsConfig ? false : true;\n\n    compiler.plugin('run', (compiler, next) => this.run(next) );\n    compiler.plugin('watch-run', (compiler, next) => this.run(next) );\n    compiler.plugin('emit', (compilation, next) => this.emit(compilation, next) );\n\n    compiler.plugin(\"normal-module-factory\", (nmf: any) => {\n      nmf.plugin('before-resolve', (result, callback) => this.beforeResolve(result, callback) );\n      nmf.plugin('after-resolve', (result, callback) => this.afterResolve(result, callback) );\n    });\n  }\n\n  emit(compilation: any, next: (err?: Error) => any): void {\n    if (!!this.options.resourceOverride && this.webpackWrapper.externalAssetsSource) {\n      const externalAssets = this.webpackWrapper.externalAssetsSource.externalAssets || {};\n      Object.keys(externalAssets).forEach( k => compilation.assets[k] = externalAssets[k] );\n    }\n\n    next();\n  }\n\n  run(next: (err?: Error) => any): void {\n    if (this.options.tsConfig) {\n      if (this.debug) {\n        console.log('Starting compilation using the angular compiler.');\n      }\n      run(this.options.tsConfig, new NgcCliOptions(this.options.cliOptions || {}), this.webpackWrapper)\n        .then( () => undefined ) // ensure the last then get's undefined if no error.\n        .catch(err => err)\n        .then(err => {\n          if (this.debug) {\n            console.log('Angular compilation done, starting webpack bundling.');\n          }\n          this.aotPass = false;\n          next(err)\n        });\n\n    } else {\n      next();\n    }\n  }\n\n  beforeResolve(result: any, callback: (err: Error | null, result) => void): void {\n    if (!this.aotPass && this.options.resourceOverride && this.webpackWrapper.aotResources[Path.normalize(result.request)] === true) {\n      result.request = this.options.resourceOverride;\n    }\n    callback(null, result);\n  }\n\n  afterResolve(result: any, callback: (err: Error | null, result) => void): void {\n    if (!this.aotPass && this.options.resourceOverride && this.webpackWrapper.aotResources[Path.normalize(result.resource)] === true) {\n      result.resource = Path.resolve(Path.dirname(result.resource), this.options.resourceOverride);\n    }\n    callback(null, result);\n  }\n}"]}